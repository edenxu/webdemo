<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">

<title>è¥é”€ä¸šåŠ¡åˆ†æåŠæ•°æ®è½¬æ¢å¹³å°</title>
<!-- Bootstrap Core CSS -->
<link href="css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/bootstrap-table.min.css">
<link rel="stylesheet" href="css/myApp.css" />
<link rel="stylesheet" href="css/zTreeStyle/metro.css" type="text/css">
</head>

<body>
	<div class="page">
		<div class="page-head">æ ¸å¿ƒåŠŸèƒ½DEMO</div>
		<div class="frame">
			<div id="treeview1" style="height:690px; overflow:auto" class="ztree"></div>
			<div id="page-wrapper" class="page-wrapper">
				<div class="row">
					<div class="col-lg-12 page-wrapper-row">
						<h6>ç»Ÿè®¡å­—æ®µï¼š[åŒå‡»å·¦ä¾§åˆ—è¡¨ä¸­çš„å­—æ®µè¿›è¡Œé€‰æ‹©]</h6>
						<div class="searchColumn-border">
							<div id="queryfields" class="panel-heading searchColumn">
								<ul id="sortablefield">
									<!-- ä¾§è¾¹æ åŒå‡»é€‰æ‹©çš„å­—æ®µå°†è¢«åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
								</ul>
							</div>
						</div>
					</div>
					<div class="col-lg-12 page-wrapper-row">
						<h6>ç­›é€‰å­—æ®µï¼š[å³é”®å•å‡»å·¦ä¾§åˆ—è¡¨ä¸­çš„å­—æ®µè¿›è¡Œé€‰æ‹©]</h6>
						<div class="searchColumn-border">
							<div id="filterfields" class="panel-heading searchColumn">
								<ul id="filterColumn">
									<!-- ä¾§è¾¹æ åŒå‡»é€‰æ‹©çš„å­—æ®µå°†è¢«åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
								</ul>
							</div>
						</div>
					</div>
					<div class="col-lg-12 page-wrapper-row">
						<div class="whereConditionPanel searchColumn-border">
							<div class="whereCondition">
								<p>
									ç­›é€‰æ¡ä»¶ï¼š
									<button type="button" class="btn  btn-default btn-sm"
										onclick="addWhereClause()">
										<span class="glyphicon glyphicon-plus"> æ·» åŠ  </span>
									</button>
									<button type="button" class="btn  btn-default btn-sm"
										id="searchButton">
										<span class="glyphicon glyphicon-search" onClick="goSearch()">
											æŸ¥ è¯¢ </span>
									</button>
									<input type="checkbox" name="saveToGxh" id="saveToGxh">ç»“æœå†åˆ†æ</input>
									<input type="text" id="myTableName" placeholder="ç»™å½“å‰ç»“æœé›†èµ·ä¸ªåˆ«å" />
								</p>
								</br>
								<div class="whereArea" id="whereArea"></div>
							</div>
						</div>
					</div>
					<!-- /.col-lg-12 -->
					<div class="col-lg-12 page-wrapper-row">
						<div class="searchColumn-border">
							<div class="result-heading">
								<div class="panel-heading-tile">ç»Ÿè®¡ç»“æœ</div>
								<button type="button" class="btn btn-sm btn-export"
									aria-label="Left Align" onClick="exportData()">
									<span class="glyphicon glyphicon-export glyphicon-align-left"
										aria-hidden="true"></span> ç»“æœå¯¼å‡º
								</button>
							</div>
							<!-- /.panel-heading -->
							<div class="panel-body" style="overflow:auto">
								<table width="100%"
									class="table table-striped table-bordered table-hover"
									id="dataTable">
								</table>
								<!-- /.table -->
							</div>
						</div>
						<!-- /.panel-body -->
					</div>
					<!-- /.col-lg-12 -->
				</div>
			</div>
		</div>
	</div>

	<!-- /#wrapper -->

	<!-- jQuery -->
	<script src="js/jquery-3.3.1.min.js"></script>
	<script src="js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/zTree/jquery.ztree.all.min.js"></script>
	<!-- Bootstrap Core JavaScript -->
	<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
	<script src="js/bootstrap-table.js"></script>
	<script src="js/bootstrap-table-zh-CN.min.js">
	<script src="js/layer/layer.js"></script>
	<script src="js/myTool.js"></script>
	<script src="js/layer/layer.js"></script>


	<script type="text/javascript">
		var t = $("#treeview1");
		var setting = {
			async : {
				enable : true,
				url : "getSjyByExampleZTree",
				autoParam : [ "zdbm", "sjybm" ],
				dataType : "json",
				otherParam : {
				},
				dataFilter : filter
			},
			data : {
				key : {
					name : 'zdmc',
					isParent : "pnode"
				},
				simpleData : {
					enable : true,
					idKey : 'zdbm',
					pIdKey : 'sjybm',
				},
			},
			callback : { //å›è°ƒå‡½æ•°  
				onDblClick : zTreeDbClick,
				onRightClick : zTreeRightClick,
			}
		};
	
		function filter(treeId, parentNode, childNodes) {
			if (!childNodes) return null;
			return childNodes;
		}
	
		function zTreeDbClick(treeId, parentNode, childNodes) {
			if (typeof (childNodes.ybzd) == 'undefined') {
				return false;
			} else {
				let data = childNodes;
				// å·²ç»æ·»åŠ è¿‡çš„å…ƒç´ ä¸å…è®¸é‡å¤åŠ å…¥
				if (selectArray.indexOf(data.ybzd) == -1) {
					selectArray.push(data.ybzd);
					let zdmc = "";
					if(data.zjbz=='Y'){
						zdmc = data.zdmc+'[ğŸ”‘]';
					}else{
						zdmc = data.zdmc;
					}
					let newNode = '<li jhbz="' + data.jhbz + '" zjbz="' + data.zjbz + '" xlzdbm="' + data.xlzdbm + '" zdmc="' + data.zdmc + '" zdbm="' + data.zdbm + '" ybzd=\'' + data.ybzd + '\' ybmc="' + data.ybmc + '" sjlx="' + data.sjlx + '" ondblclick="deleteSelectNode(this)" class="btn  my-btn btn-sm" style="margin:2px;">' + zdmc + '</li>';
					$("#sortablefield").append(newNode);
					if (selectArray.length > 0) {
						$('#queryfields').removeClass('searchColumn');
					} else {
						$('#queryfields').addClass('searchColumn');
					}
					return true;
				} else {
					layer.alert('è¯¥å­—æ®µå·²æ·»åŠ åˆ°ç»Ÿè®¡åŒº.', {
						icon : 6,
						title : 'æ¸©é¦¨æç¤º'
					});
					return false;
				}
			}
		}
	
		function zTreeRightClick(treeId, parentNode, childNodes) {
			if (typeof (childNodes.ybzd) == 'undefined') {
				return false;
			} else {
				let data = childNodes;
				// é¦–å…ˆæ£€æŸ¥è¯¥å­—æ®µæ˜¯å¦ä¸å·²æ·»åŠ çš„å­—æ®µå­˜åœ¨å…³è”æ€§ï¼Œå³ï¼šç­›é€‰å­—æ®µä¸å·²é€‰æ‹©çš„æŸç»Ÿè®¡å­—æ®µæ¥æºäºåŒä¸€å¼ è¡¨
				let list = $('#sortablefield').children();
				let stopFlag = true;
				list.each(function(id, value) {
					if (data.ybmc == $(value).attr("ybmc")) {
						stopFlag = false;
						return false;
					}
				});
				if (stopFlag) {
					layer.alert('è¯¥ç­›é€‰å­—æ®µ:ã€' + data.zdmc + 'ã€‘ä¸ç»Ÿè®¡å­—æ®µåˆ—è¡¨æ— å¼ºå…³è”å…³ç³»ï¼Œæ— æ³•ä¸ºæ‚¨æä¾›å‡†ç¡®ç­›é€‰ã€‚');
					return;
				}
				// å·²ç»æ·»åŠ è¿‡çš„å…ƒç´ ä¸å…è®¸é‡å¤åŠ å…¥
				if (filterArray.indexOf(data.ybzd) == -1) {
					filterArray.push(data.ybzd);
					let newNodeFilter = '<li jhbz="' + data.jhbz + '" zjbz="' + data.zjbz + '" xlzdbm="' + data.xlzdbm + '" zdmc="' + data.zdmc + '" zdbm="' + data.zdbm + '" ybzd=\'' + data.ybzd + '\' ybmc="' + data.ybmc + '" sjlx="' + data.sjlx + '" ondblclick="deleteFilterNode(this)"  class="btn my-btn btn-sm" style="margin:2px;">' + data.zdmc + '</li>';
					$("#filterColumn").append(newNodeFilter);
					if (filterArray.length > 0) {
						$('#filterfields').removeClass('searchColumn');
					} else {
						$('#filterfields').addClass('searchColumn');
					}
					return true;
				} else {
					layer.alert('è¯¥å­—æ®µå·²æ·»åŠ åˆ°è¿‡æ»¤åŒº.', {
						icon : 6,
						title : 'æ¸©é¦¨æç¤º'
					});
					return false;
				}
			}
		}
	
		var defaultData = [];
		var $selectableTree;
		// é€‰æ‹©å­—æ®µ
		var selectArray = new Array();
		// è¿‡æ»¤å­—æ®µ
		var filterArray = new Array();
		var optionString = '<select class="form-control"><option value=" > "> > </option><option value=" >= "> >= </option><option value=" = "> = </option>'
			+ '<option value=" < "> < </option><option value=" <= "> <= </option><option value=" IN "> IN </option><option value=" NOT IN "> NOT IN </option><option value=" LIKE "> LIKE </option></select>';
		var optionBefore = '<select class="form-control"><option value="">  </option><option value=" ( "> ( </option></select>';
		var optionAfter = '<select class="form-control"><option value="">  </option><option value=" ) "> ) </option></select>';
		var optionRela = '<select class="form-control"><option value="">  </option><option value=" AND "> AND </option><option value=" OR "> OR </option></select>';
		var deleteButton = '<button type="button" class="btn btn-warning" onClick="deleteCurrentRow(this)"><span class="glyphicon glyphicon-remove"> åˆ  é™¤ </span></button>';
	
		var whereConditionSQL = '';
		var havingConditionSQL = '';
		var groupClauseSQL = '';
		var groupMode = 'N';
		// å½“å‰æ•°æ®è¡¨æ ¼åŠ è½½çš„æ•°æ®è¡¨åç§°
		var $dataTable = $('#dataTable');
		// å½“å‰æ•°æ®é›†å±•ç¤ºçš„è¡¨å
		var table = "";
		// å½“å‰æ•°æ®é›†è¡¨å¤´ä¿¡æ¯
		var columsArray = new Array();
		// æœ¬æ¬¡æŸ¥è¯¢æ‰€æ¶‰åŠçš„æ•°æ®è¡¨æ¸…å•
		var selectTables = new Array();
		var beginTime,
			endTime;
	
		// åˆ é™¤é€‰ä¸­ç»Ÿè®¡å­—æ®µ
		function deleteSelectNode(value) {
			let mapValue = $(value).attr("ybzd");
			// ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²å–æ¶ˆçš„å­—æ®µ
			selectArray.remove(mapValue);
			// ä»DOMä¸­åˆ é™¤å¯¹åº”å­—æ®µå†…å®¹
			value.remove();
			if (selectArray.length > 0) {
				$('#queryfields').removeClass('searchColumn');
			} else {
				$('#queryfields').addClass('searchColumn');
			}
		}
	
		// åˆ é™¤é€‰ä¸­ç­›é€‰å­—æ®µ
		function deleteFilterNode(value) {
			let mapValue = $(value).attr("ybzd");
			// ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²å–æ¶ˆçš„å­—æ®µ
			filterArray.remove(mapValue);
			// ä»DOMä¸­åˆ é™¤å¯¹åº”å­—æ®µå†…å®¹
			value.remove();
			if (selectArray.length > 0) {
				$('#filterArray').removeClass('searchColumn');
			} else {
				$('#filterArray').addClass('searchColumn');
			}
		}
	
		$(document).ready(function() {
			$.ajax({
				url : 'getSjyByExampleZTree',
				type : 'POST', //GET
				async : true, //æˆ–false,æ˜¯å¦å¼‚æ­¥
				data : {
					zdbm : '000',
				},
				dataType : 'json', //è¿”å›çš„æ•°æ®æ ¼å¼ï¼šjson/xml/html/script/jsonp/text
				success : function(data, textStatus, jqXHR) {
					//console.log(data);
					//console.log(JSON.parse(data));
					t = $.fn.zTree.init(t, setting, JSON.parse(data));
				},
				error : function(xhr, textStatus) {
					console.log('é”™è¯¯')
					console.log(xhr)
					console.log(textStatus)
				},
				complete : function() {
					//console.log('Ajaxå¤„ç†ç»“æŸ');
				}
			});
			$("#sortablefield").sortable();
			$("#sortablefield").disableSelection();
		});
	
		// æäº¤æŸ¥è¯¢å¤„ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
		function goSearch() {
			let saveFlag = $("input[name='saveToGxh']:checked").val();
			let myTableName = '';
			if (typeof saveFlag !== 'undefined') {
				saveFlag = 'Y';
				myTableName = $('#myTableName').val();
				if (myTableName === '') {
					layer.alert('ä¸ºäº†è¿›è¡Œç»“æœé›†å†åˆ†æï¼Œéœ€è¦ç»™å½“å‰çš„ç»“æœé›†å®šä¹‰ä¸€ä¸ªåˆ«å.');
					return;
				}
			} else {
				saveFlag = 'N';
			}
			beginTime = new Date();
			whereConditionSQL = '';
			groupClauseSQL = '';
			havingConditionSQL = '';
			// æ˜¯å¦éœ€è¦è¿›è¡Œåˆ†ç»„å¤„ç†æ ‡å¿—
			groupMode = 'N';
			let list = $('#sortablefield').children();
			if (list.length <= 0) {
				layer.alert('æ‚¨å°šæœªé€‰æ‹©ä»»ä½•æŸ¥è¯¢å­—æ®µ.');
				return;
			}
			// å‚æ•°å¯¹è±¡å°è£…
			let paramsObject = new Object();
			selectTables = new Array();
			let zjbz = 'N';
			let continueCompare = true;
			list.each(function(id, value) {
				let obj = new Object();
				obj.zdbm = $(value).attr('zdbm');
				obj.ybmc = $(value).attr('ybmc');
				obj.ybzd = $(value).attr('ybzd');
				obj.sjlx = $(value).attr('sjlx');
				obj.zjbz = $(value).attr('zjbz');
				selectTables.push(obj);
				// åˆ¤æ–­å­—æ®µæ˜¯å¦åŒ…å«ä¸»é”®å­—æ®µ
				if ($(value).attr('zjbz') === 'Y') {
					zjbz = 'Y';
				}
				// æ‹¼è£…GroupByæ¡ä»¶çš„å­—æ®µå†…å®¹
				if ($(value).attr('jhbz') == 'N') {
					groupClauseSQL += $(value).attr('ybzd') + ',';
				} else {
					groupMode = 'Y';
				}
			});
	
			// å»æ‰æœ€åå¤šä½™çš„é€—å·
			groupClauseSQL = groupClauseSQL.substring(0, groupClauseSQL.length - 1);
			// console.log(selectTables);
			// å¤„ç†Whereæ¡ä»¶ï¼Œå°†ç»“æœè£…è½½åˆ°whereConditionSQL
			dealWhereClause();
			//console.log("havingConditionSQL:" + havingConditionSQL);
			//console.log("groupMode:" + groupMode);
			paramsObject.selectTables = selectTables;
			paramsObject.whereClause = whereConditionSQL;
			paramsObject.havingClause = havingConditionSQL;
			paramsObject.groupClause = groupClauseSQL;
			paramsObject.groupFlag = groupMode;
			paramsObject.saveFlag = saveFlag;
			paramsObject.myTableName = myTableName;
			// å±•ç¤ºåŠ è½½å±‚
			layer.load();
			// å±è”½æŸ¥è¯¢æŒ‰é’®
			$("#searchButton").attr("disabled", true);
			if (zjbz === 'N' && saveFlag === 'Y') {
				layer.msg('é‡è¦æé†’ï¼šæ‚¨å½“å‰çš„ç»“æœé›†ä¸åŒ…å«ä¸»é”®å­—æ®µï¼Œå¦‚åŸºäºæ­¤ç»“æœé›†ä¸å…¶ä»–æ•°æ®é›†è¿›è¡Œå…³è”æŸ¥è¯¢ï¼Œå°†æ— æ³•ä¿éšœæ•°æ®çš„å‡†ç¡®æ€§ã€‚ä½†æ‚¨ä»å¯ä»¥å¯¹æ­¤ç»“æœé›†è¿›è¡Œå†æ¬¡ç­›é€‰åˆ†æã€‚');
			}
			$.ajax({
				url : 'dealSelectedSQL',
				type : 'POST', //GET
				contentType : 'application/json',
				async : true, //æˆ–false,æ˜¯å¦å¼‚æ­¥
				data : JSON.stringify(paramsObject),
				//timeout : 5000, //è¶…æ—¶æ—¶é—´
				dataType : 'json', //è¿”å›çš„æ•°æ®æ ¼å¼ï¼šjson/xml/html/script/jsonp/text
				success : function(data, textStatus, jqXHR) {
					let executeSql = data.sql;
					if (executeSql === "") {
						layer.alert("æ‚¨é€‰æ‹©çš„å­—æ®µä¹‹é—´æ— æ³•å‡†ç¡®è¿›è¡Œå…³è”æŸ¥è¯¢ï¼Œè¯·é‡æ–°é€‰æ‹©è¦æŸ¥è¯¢çš„å­—æ®µï¼Œè°¢è°¢.");
						// å…³é—­åŠ è½½å±‚
						layer.closeAll('loading');
						return;
					}
					var columns = data.columns;
					columsArray = [];
					// ç»™è¡¨å¤´å­—æ®µæ·»åŠ è¾…åŠ©å±æ€§
					for (var i = 0; i < columns.length; i++) {
						var obj = new Object();
						obj = columns[i];
						obj.sortable = true;
						obj.align = 'center';
						columsArray.push(obj);
					}
					table = data.tableName;
	
					// åˆå§‹åŒ–æ•°æ®è¡¨æ ¼
					$dataTable.bootstrapTable('destroy');
					$dataTable.bootstrapTable({
						url : "getTableDataByTableName",
						dataType : "json",
						singleSelect : false,
						datalocale : "zh-US", //è¡¨æ ¼æ±‰åŒ–
						search : false, //æ˜¾ç¤ºæœç´¢æ¡†
						sidePagination : "server", //æœåŠ¡ç«¯å¤„ç†åˆ†é¡µ
						//height : tableHeight(), //é«˜åº¦è°ƒæ•´
						pagination : true, //æ˜¯å¦åˆ†é¡µ
						pageSize : 20, //å•é¡µè®°å½•æ•°
						pageList : [ 5, 10, 20, 50 ], //åˆ†é¡µæ­¥è¿›å€¼
						sidePagination : "server", //æœåŠ¡ç«¯åˆ†é¡µ
						contentType : "application/x-www-form-urlencoded", //è¯·æ±‚æ•°æ®å†…å®¹æ ¼å¼ é»˜è®¤æ˜¯ application/json è‡ªå·±æ ¹æ®æ ¼å¼è‡ªè¡ŒæœåŠ¡ç«¯å¤„ç†
						method : "post", //è¯·æ±‚æ–¹å¼
						//searchAlign : "right", //æŸ¥è¯¢æ¡†å¯¹é½æ–¹å¼
						queryParamsType : "limit", //æŸ¥è¯¢å‚æ•°ç»„ç»‡æ–¹å¼
						queryParams : function getParams(params) {
							params.tableName = table;
							return params;
						},
						//searchOnEnterKey : true, //å›è½¦æœç´¢
						//showRefresh : true, //åˆ·æ–°æŒ‰é’®
						//showColumns : true, //åˆ—é€‰æ‹©æŒ‰é’®
						//buttonsAlign : "right", //æŒ‰é’®å¯¹é½æ–¹å¼
						toolbar : "#toolbar", //æŒ‡å®šå·¥å…·æ 
						toolbarAlign : "right", //å·¥å…·æ å¯¹é½æ–¹å¼
						columns : columsArray,
						onLoadSuccess : function(data) {
							// å…³é—­åŠ è½½å±‚
							layer.closeAll('loading');
							// æ¢å¤ç»Ÿè®¡æŒ‰é’®çŠ¶æ€
							$("#searchButton").attr("disabled", false);
							endTime = new Date();
							let totalTime = Math.round((endTime.getTime() - beginTime.getTime()) / 1000);
							layer.alert("æœ¬æ¬¡ç»Ÿè®¡æ€»å…±è€—æ—¶ï¼š " + totalTime + " ç§’", function() {
								layer.alert('æœ¬æ¬¡æŸ¥è¯¢ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„SQLè¯­å¥æ˜¯:' + executeSql);
							});
						},
						onPageChange : function(data) {
							// ç¿»é¡µçš„æ—¶å€™é‡æ–°è®¡ç®—å¼€å§‹æ—¶é—´
							beginTime = new Date();
						},
						onLoadError : function() {
							// å…³é—­åŠ è½½å±‚
							layer.closeAll('loading');
							// æ¢å¤ç»Ÿè®¡æŒ‰é’®çŠ¶æ€
							$("#searchButton").attr("disabled", false);
						}
					});
				},
				error : function(xhr, textStatus) {
					// å…³é—­åŠ è½½å±‚
					layer.closeAll('loading');
					$("#searchButton").attr("disabled", false);
					console.log('é”™è¯¯')
					console.log(xhr)
				},
				complete : function() {
					// console.log('Ajaxå¤„ç†ç»“æŸ')
				}
			});
		}
	
		// æ·»åŠ Whereæ¡ä»¶é€‰æ‹©è¡Œ
		function addWhereClause() {
			//let list = $('#sortablefield').children();
			let list = $('#filterColumn').children();
			if (list.length <= 0) {
				layer.alert('æ‚¨å°šæœªé€‰æ‹©ä»»ä½•æŸ¥è¯¢å­—æ®µ.');
				return;
			}
			let whereClause = $('#whereArea');
			let innerHTML = '<div class="whereClauseColumn form-inline">';
			let temp = optionBefore + '<select class="form-control" onChange="refreshInputDataType(this)" ><option value="none">-----é€‰æ‹©å­—æ®µ-----</option>';
			list.each(function(id, value) {
				temp += "<option value='" + $(value).attr('ybzd') + "." + $(value).attr('jhbz') + "." + $(value).attr('sjlx') + "' zdbm='" + $(value).attr('zdbm') + "' xlzdbm='" + $(value).attr('xlzdbm') + "'>" + $(value).attr('zdmc') + "</option>";
			});
			innerHTML += temp + '</select>' + optionString;
			let tempValue = "<input type=text class='form-control'/>";
			tempValue += optionAfter + optionRela + deleteButton;
			innerHTML += tempValue + '</div>';
			whereClause.append(innerHTML);
		}
	
		// å¯¹SQLè¯­å¥çš„Whereå’ŒHavingæ¡ä»¶è¿›è¡Œå¤„ç†
		function dealWhereClause() {
			let list = $('#whereArea').children();
			// éå†ç­›é€‰åŒºåŸŸçš„æ‰€æœ‰DOMï¼Œå¹¶æå–ç›¸å…³å±æ€§
			list.each(function(id, value) {
				//console.log(value);
				let columnType = '',
					columnName = '',
					jhbz = '',
					swapString = '';
				$(value).children().each(function(id, value) {
					// å­—æ®µåç§°ç‰¹æ®Šå¤„ç†
					if (id == 1) {
						// è·å–å­—æ®µåç§°
						columnName = $(value).val().substr(0, $(value).val().length - 4);
						// è·å–å­—æ®µç±»å‹ï¼Œä¸»è¦ç”¨äºæ‹¼è£…SQLæ—¶å¯¹ä¸åŒç±»å‹çš„å­—æ®µè¿›è¡Œå¤„ç†[C:å­—ç¬¦,N:æ•°å­—,T:æ—¶é—´]
						columnType = $(value).val().substr($(value).val().length - 1, 1);
						// èšåˆæ ‡å¿—ï¼Œåˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦å±äºèšåˆç±»å‹çš„å­—æ®µ
						jhbz = $(value).val().substr($(value).val().length - 3, 1);
						//console.log("jhbz:" + jhbz);
						//whereConditionSQL += columnName;
						swapString = columnName;
					} else if (id == 3) {
						let tzbz = (typeof ($(value).find("option:selected").attr("tzbz")) == 'undefined') ? "N" : $(value).find("option:selected").attr("tzbz");
						// æ‹“å±•ä¸‹æ‹‰å­—æ®µéœ€ç‰¹æ®Šå¤„ç†
						if (tzbz == 'N') {
							if( (columnType == 'C' || columnType == 'T') ) {
								// whereConditionSQL = whereConditionSQL + '\'' + $(value).val() + '\'';
								swapString = swapString + '\'' + $(value).val() + '\'';
							} else {
								//whereConditionSQL += $(value).val();
								swapString += $(value).val();
							}
						} else {
							// è·å–æ‹“å±•å­—æ®µéœ€è¦æ¶‰åŠåˆ°çš„æ•°æ®è¡¨
							let ybObject = new Object();
							ybObject.ybmc = $(value).find("option:selected").attr("ybmc");
							ybObject.ybzd = '';
							// å°†æ‹“å±•ä¸‹æ‹‰æ¶‰åŠçš„æ•°æ®è¡¨åŠ å…¥æœ¬æ¬¡æŸ¥è¯¢æ‰€æ¶‰åŠçš„æ•°æ®è¡¨æ¸…å•
							selectTables.push(ybObject);
							//å»æ‰å‰é¢çš„æ“ä½œç¬¦æ ‡å¿—ä½
							//swapString = swapString.substtring(0,tempString.length - 1)
							//console.log("æœ€åå‡ºç°ç©ºæ ¼çš„åœ°æ–¹ï¼š" + swapString.trim().lastIndexOf(' '));
							swapString = swapString.substring(0, swapString.trim().lastIndexOf(' '));
							// å› åå°è¿”å›çš„æ•°å€¼ä¸º01,02,03æ ·å¼çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œåˆ†å‰²å¤„ç†
							let dropDownValues = $(value).val().split(',');
							let arrayLength = dropDownValues.length;
							let tempString = ' IN (';
							for (let i = 0; i < arrayLength; i++) {
								if( (columnType == 'C' || columnType == 'T') ) {
									tempString += '\'' + dropDownValues[i] + '\',';
								} else {
									tempString += dropDownValues[i] + ',';
								}
							}
							tempString = tempString.substring(0, tempString.length - 1) + ')';
							swapString += tempString;
						}
					} else if (id != 6) {
						// whereConditionSQL += $(value).val();
						swapString += $(value).val();
					}
				}
				);
				// æ ¹æ®å½“å‰æ¡ä»¶æ˜¯å¦ä¸ºèšåˆå­—æ®µï¼Œé€‰æ‹©æ”¾å…¥åˆ°Whereéƒ¨åˆ†è¿˜æ˜¯Havingéƒ¨åˆ†
				if (jhbz != 'Y') {
					whereConditionSQL += swapString;
				} else {
					groupMode = 'Y';
					console.log('èšåˆå­—æ®µ:' + columnName);
					havingConditionSQL += swapString;
				}
			});
			//----å¤„ç†å¤šä½™çš„AND å’Œ OR
			let abc = whereConditionSQL.lastIndexOf(" ");
			var lengthIndex = whereConditionSQL.length - 1;
			//console.log("abc:" + abc + "ï¼Œlength:" + length);
			if (abc == lengthIndex) {
				whereConditionSQL = whereConditionSQL.substring(0, whereConditionSQL.length - 4);
			}
			abc = havingConditionSQL.lastIndexOf(" ");
			lengthIndex = havingConditionSQL.length - 1;
			//console.log("abc:" + abc + "ï¼Œlength:" + length);
			if (abc == lengthIndex) {
				havingConditionSQL = havingConditionSQL.substring(0, havingConditionSQL.length - 4);
			}
		//console.log('whereConditionSQL:' + whereConditionSQL);
		//console.log('havingConditionSQL:' + havingConditionSQL);
		}
	
		// åˆ é™¤å½“å‰è¡Œçš„ç­›é€‰æ¡ä»¶
		function deleteCurrentRow(value) {
			$(value).parent().remove();
		}
	
		// æ›´æ–°
		function refreshInputDataType(value) {
			let xlzdbm = $(value).find("option:selected").attr("xlzdbm");
			$.ajax({
				url : 'getColumnDropDownList',
				type : 'POST', //GET
				contentType : 'application/x-www-form-urlencoded',
				async : true, //æˆ–false,æ˜¯å¦å¼‚æ­¥
				data : {
					xlzdbm : xlzdbm,
				},
				//timeout : 5000, //è¶…æ—¶æ—¶é—´
				dataType : 'json', //è¿”å›çš„æ•°æ®æ ¼å¼ï¼šjson/xml/html/script/jsonp/text
				success : function(data, textStatus, jqXHR) {
					//console.log(data);
					if (data.result.length > 0) {
						//console.log($(value).parent());
						//console.log($(value).next().next());
						let selectOption = '<select class="form-control">';
						let optionString = '';
						// ä¸‹æ‹‰èœå•æ‹“å±•æ ‡å¿—ä½
						let tzFlag = 'N';
						let newOptionValue = '';
						for (let i = 0; i < data.result.length; i++) {
							tzFlag = data.result[i].tzbz;
							newOptionValue = data.result[i].ybzd;
							optionString += '<option value="' + data.result[i].sjz + '" tzbz="' + data.result[i].tzbz + '" ybmc="' + data.result[i].ybmc + '">' + data.result[i].xsz + '</option>';
						}
						selectOption += optionString + '</select>';
						if (tzFlag == 'Y') {
							// å°†Optionä¸­çš„Valueæ¢æˆæ‹“å±•ä»¥åçš„å€¼
							let oldOptionValue = $(value).find("option:selected").attr("value");
							newOptionValue += oldOptionValue.substring(oldOptionValue.length - 4);
							$(value).find("option:selected").attr("value", newOptionValue);
						//console.log($(value).find("option:selected").attr("value"));
						}
						let replaceNode = $(value).next().next();
						$(replaceNode).before(selectOption);
						replaceNode.remove();
					} else {
						let replaceNode = $(value).next().next();
						let inputNode = "<input type=text class='form-control'/>";
						$(replaceNode).before(inputNode);
						replaceNode.remove();
					}
				}
			});
		}
	
		function exportData() {
			if ($dataTable.bootstrapTable('getData').length <= 0 || table == "") {
				layer.msg('å½“å‰æ— å¯å¯¼å‡ºæ•°æ®', {
					icon : 1
				});
				return;
			}
			$.ajax({
				url : 'exportData',
				type : 'POST', //GET
				contentType : 'application/x-www-form-urlencoded',
				async : true, //æˆ–false,æ˜¯å¦å¼‚æ­¥
				data : {
					tableName : table,
				},
				//timeout : 5000, //è¶…æ—¶æ—¶é—´
				dataType : 'json', //è¿”å›çš„æ•°æ®æ ¼å¼ï¼šjson/xml/html/script/jsonp/text
				success : function(data, textStatus, jqXHR) {
					//layer.alert('æ–‡ä»¶å·²ç”Ÿæˆï¼Œæ–‡ä»¶åä¸º:' + data.fileName);
					window.location = "ftp://192.168.0.200/" + data.fileName;
				}
			});
		}
	</script>
</body>

</html>